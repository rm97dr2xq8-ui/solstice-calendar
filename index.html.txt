<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>13-Month Solstice Calendar</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">

<style>
body {
  font-family: system-ui, -apple-system, sans-serif;
  margin: 0;
  padding: 1rem;
  background: #f6f6f6;
}
h1 {
  text-align: center;
}
.controls {
  text-align: center;
  margin-bottom: 0.5rem;
}
select {
  font-size: 1rem;
  padding: 0.3rem;
}
.weekdays, .calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  text-align: center;
}
.weekdays div {
  font-weight: bold;
  padding: 0.3rem 0;
}
.calendar {
  gap: 4px;
}
.day {
  background: white;
  border-radius: 6px;
  padding: 6px;
  min-height: 80px;
  cursor: pointer;
}
.num {
  font-size: 1.2rem;
  font-weight: bold;
}
.greg {
  font-size: 0.75rem;
  color: #666;
}
.note {
  font-size: 0.75rem;
}
.footer {
  text-align: center;
  margin-top: 0.8rem;
  font-style: italic;
}
.legend {
  text-align: center;
  font-size: 0.8rem;
  margin-top: 0.5rem;
}
</style>
</head>

<body>

<h1>13-Month Solstice Calendar</h1>

<div class="controls">
  Year:
  <select id="yearSelect"></select>
  Month:
  <select id="monthSelect"></select>
</div>

<div class="weekdays">
  <div>Lunae</div><div>Mars</div><div>Mercur</div>
  <div>Jupiter</div><div>Venus</div><div>Saturn</div><div>Sol</div>
</div>

<div class="calendar" id="calendar"></div>

<div class="legend">
 New 路  Waxing 路  First 路  Waxing Gibbous 路  Full 路  Waning 路  Last 路  Waning
</div>

<div class="footer" id="feriae"></div>

<script>
// =====================
// CONSTANTS
// =====================
const months = [
  "Gerar","Furar","Mrior","Prier","Florar","Cirear",
  "Cuptora","Cuptor","Gustar","Rpciune",
  "Brumrel","Brumar","Ghear"
];

// =====================
// SOLSTICE CALCULATION
// =====================
function winterSolsticeUTC(year) {
  const Y = (year - 2000) / 1000;
  const JDE =
    2451900.05952 +
    365242.74049 * Y -
    0.06223 * Y * Y -
    0.00823 * Y * Y * Y +
    0.00032 * Y * Y * Y * Y;

  return new Date((JDE - 2440587.5) * 86400000);
}

// =====================
// MOON PHASE
// =====================
function moonPhase(date) {
  const knownNewMoon = Date.UTC(2000, 0, 6, 18, 14);
  const synodic = 29.530588853;
  const days = (date.getTime() - knownNewMoon) / 86400000;
  const phase = ((days % synodic) + synodic) % synodic;

  if (phase < 1.85) return "";
  if (phase < 5.54) return "";
  if (phase < 9.23) return "";
  if (phase < 12.92) return "";
  if (phase < 16.61) return "";
  if (phase < 20.30) return "";
  if (phase < 23.99) return "";
  if (phase < 27.68) return "";
  return "";
}

// =====================
// NOTES
// =====================
function noteKey(y, m, d) {
  return `note-${y}-${m}-${d}`;
}

// =====================
// UI SETUP
// =====================
const yearSelect = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");
const calendar = document.getElementById("calendar");
const feriae = document.getElementById("feriae");

for (let y = 2020; y <= 2040; y++) {
  yearSelect.add(new Option(y, y));
}
months.forEach((m, i) => monthSelect.add(new Option(m, i)));

yearSelect.value = new Date().getFullYear();
monthSelect.value = 0;

// =====================
// RENDER
// =====================
function isLeap(y) {
  return (y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0);
}

function render() {
  calendar.innerHTML = "";
  feriae.textContent = "";

  const year = +yearSelect.value;
  const monthIndex = +monthSelect.value;
  const solstice = winterSolsticeUTC(year);

  for (let d = 0; d < 28; d++) {
    const g = new Date(solstice);
    g.setUTCDate(solstice.getUTCDate() + monthIndex * 28 + d);

    const key = noteKey(year, monthIndex, d + 1);
    const saved = localStorage.getItem(key);
    const phase = moonPhase(g);

    const cell = document.createElement("div");
    cell.className = "day";
    cell.innerHTML = `
      <div class="num">${d + 1}</div>
      <div class="greg">${g.toDateString()}</div>
      <div>${phase}</div>
      <div class="note">${saved ? "" : ""}</div>
    `;

    cell.onclick = () => {
      const note = prompt(
        `Note for ${months[monthIndex]} ${d + 1}`,
        saved || ""
      );
      if (note === null) return;
      if (note.trim()) localStorage.setItem(key, note);
      else localStorage.removeItem(key);
      render();
    };

    calendar.appendChild(cell);
  }

  feriae.textContent =
    "Feriae: " + (isLeap(year) ? "2 days" : "1 day") + " outside time";
}

yearSelect.onchange = render;
monthSelect.onchange = render;
render();

// =====================
// SERVICE WORKER
// =====================
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
